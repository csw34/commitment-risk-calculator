<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Commitment & Risk Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">Commitment & Risk Calculator</h1>
        <p class="text-slate-600">Import your CUD portfolio CSV to visualize remaining commitment outstanding over time.</p>
      </div>
      <div>
        <input id="csvFile" type="file" accept=".csv" class="block text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
      </div>
    </header>

    <canvas id="commitmentChart" class="w-full h-80 bg-white rounded-2xl shadow p-5"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('commitmentChart').getContext('2d');
    let chart;

    // CSV parsing helper
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split('\t');
      return lines.slice(1).map(line => {
        const values = line.split('\t');
        const row = {};
        headers.forEach((h, i) => row[h.trim()] = values[i]?.trim());
        return row;
      });
    }

    // Calculate remaining commitment outstanding per day
    function calculateOutstanding(data) {
      const today = new Date();
      const endDates = data
        .filter(d => d.State === "Active" && d["End Time"])
        .map(d => new Date(d["End Time"]));
      const maxEnd = new Date(Math.max(...endDates.map(d => d.getTime())));

      const dailyData = [];
      const oneDay = 24 * 60 * 60 * 1000;

      for (let d = new Date(today); d <= maxEnd; d = new Date(d.getTime() + oneDay)) {
        let total = 0;
        data.forEach(row => {
          if (row.State === "Active" && new Date(row["End Time"]) > d) {
            const end = new Date(row["End Time"]);
            const daysLeft = (end - d) / oneDay;
            const activeCommit = parseFloat(row["Active Commitment"]) || 0;
            total += activeCommit * daysLeft * 24; // hours left
          }
        });
        dailyData.push({ date: d.toISOString().split('T')[0], outstanding: total });
      }
      return dailyData;
    }

    // Render Chart.js line chart
    function renderChart(dailyData) {
      const labels = dailyData.map(d => d.date);
      const values = dailyData.map(d => d.outstanding);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Remaining Commitment Outstanding (hours)',
            data: values,
            borderWidth: 2,
            tension: 0.2,
            borderCol
